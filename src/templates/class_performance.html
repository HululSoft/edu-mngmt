{% extends "base.html" %}

{% block head %}
    <title>{% block title %}Ø£Ø¯Ø§Ø¡ Ø§Ù„ØµÙ - {{ selected_class.name }}{% endblock %}</title>
    <style>
        .performance-card {
            transition: transform 0.2s;
        }
        .performance-card:hover {
            transform: translateY(-2px);
        }
        .rank-badge {
            font-size: 1.2em;
            line-height: 0.6em;
        }
        .student-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .student-row:hover {
            background-color: rgba(0,123,255,0.1);
        }

        /* Responsive table: stack rows on small screens to avoid horizontal scrolling */
        @media (max-width: 768px) {
            .table-responsive thead {
                display: none; /* hide header on small screens */
            }
            .table-responsive table,
            .table-responsive tbody,
            .table-responsive tr,
            .table-responsive td,
            .table-responsive th {
                display: block;
                width: 100%;
            }
            .table-responsive tr {
                border: 1px solid #e9ecef;
                border-radius: .375rem;
                margin-bottom: .75rem;
                padding: .5rem;
            }
            .table-responsive td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: .5rem .75rem;
                border: none;
                background: transparent;
            }
            .table-responsive td:before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 0.75rem;
                color: #495057;
            }
            /* Make progress bar and badges fit better on small screens */
            .table-responsive .progress { width: 90px !important; height: 14px !important; }
            .table-responsive .progress-bar { height: 14px !important; }
            .table-responsive .badge { white-space: nowrap; }

            .rank-badge {
                font-size: 1.5em;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" class="form-control" id="startDate" value="{{ start_date }}">
                        </div>
                        <div class="col-md-4">
                            <label for="endDate" class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" class="form-control" id="endDate" value="{{ end_date }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end mt-3 mt-md-3">
                            <button class="btn btn-primary" onclick="updatePerformanceData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Performance Summary -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h4 class="mb-3">ğŸ“Š Ø£Ø¯Ø§Ø¡ Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ù…</h4>
            <div class="row">
                <div class="col-md-3">
                    <div class="card performance-card text-center">
                        <div class="card-body">
                            <h2 class="text-primary">{{ "%.1f"|format(class_performance.class_attendance_percentage) }}%</h2>
                            <p class="text-muted mb-0">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card performance-card text-center">
                        <div class="card-body">
                            <h2 class="text-success">{{ class_performance.total_present_attendance_records }}</h2>
                            <p class="text-muted mb-0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card performance-card text-center">
                        <div class="card-body">
                            <h2 class="text-warning">{{ class_performance.total_attendance_records - class_performance.total_present_attendance_records }}</h2>
                            <p class="text-muted mb-0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card performance-card text-center">
                        <div class="card-body">
                            <h2 class="text-info">{{ class_performance.lesson_dates_count }}</h2>
                            <p class="text-muted mb-0">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Performance -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ‘¥ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="sortStudents('rank', event)">Ø§Ù„ØªØ±ØªÙŠØ¨</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortStudents('attendance', event)">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortStudents('streak', event)">Ø§Ù„Ø¥Ù†ØªØ¸Ø§Ù…</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortStudents('name', event)">Ø§Ù„Ø§Ø³Ù…</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="studentsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                                    <th>Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø­Ø¶ÙˆØ±Ø©</th>
                                    <th>Ø£Ø·ÙˆÙ„ ÙØªØ±Ø© Ø§Ù†ØªØ¸Ø§Ù…</th>
                                    <th>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                    <th>Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                {% for perf in student_performances %}
                                <tr class="student-row"
                                    data-rank="{{ perf.rank }}"
                                    data-attendance="{{ perf.attendance_percentage }}"
                                    data-streak="{{ perf.longest_streak }}"
                                    data-name="{{ perf.student.name }}"
                                    onclick="viewStudentDetails({{ perf.student.id }})">
                                    <td data-label="Ø§Ù„ØªØ±ØªÙŠØ¨">
                                        <span class="position-relative">
                                            {% if perf.rank <= 3 %}
                                                {% if perf.rank == 1 %}
                                                <span class="badge rank-badge">ğŸ¥‡</span>
                                                {% elif perf.rank == 2 %}
                                                <span class="badge rank-badge">ğŸ¥ˆ</span>
                                                {% elif perf.rank == 3 %}
                                                <span class="badge rank-badge">ğŸ¥‰</span>
                                                {% endif %}
                                            {% else %}
                                                #{{ perf.rank }}
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td data-label="Ø§Ù„Ø·Ø§Ù„Ø¨">
                                        <strong>{{ perf.student.name }}</strong>
                                    </td>
                                    <td data-label="Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±">
                                        <div class="d-flex align-items-center">
                                            <div class="progress ms-2" style="width: 100px; height: 20px;">
                                                <div class="progress-bar
                                                    {% if perf.attendance_percentage >= 90 %}bg-success
                                                    {% elif perf.attendance_percentage >= 75 %}bg-warning
                                                    {% else %}bg-danger{% endif %}"
                                                     style="width: {{ perf.attendance_percentage }}%">
                                                </div>
                                            </div>
                                            <span class="fw-bold">{{ "%.1f"|format(perf.attendance_percentage) }}%</span>
                                        </div>
                                    </td>
                                    <td data-label="Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø­Ø¶ÙˆØ±Ø©">
                                        <span class="badge bg-info">{{ perf.attended_lessons }}/{{ perf.total_lessons }}</span>
                                    </td>
                                    <td data-label="Ø£Ø·ÙˆÙ„ ÙØªØ±Ø© Ø§Ù†ØªØ¸Ø§Ù…">
                                        {% if perf.longest_streak > 0 %}
                                        <span class="badge bg-success">ğŸ”¥ {{ perf.longest_streak }} ÙŠÙˆÙ…</span>
                                        {% else %}
                                        <span class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Ø§Ù„Ø§Ù†ØªØ¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ">
                                        {% if perf.current_streak > 0 %}
                                        <span class="badge bg-primary">{{ perf.current_streak }} ÙŠÙˆÙ…</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨">
                                        {% if perf.absent_days > 0 %}
                                        <span class="badge bg-danger">{{ perf.absent_days }}</span>
                                        {% else %}
                                        <span class="badge bg-success">0</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    setNavbarTitle("Ø£Ø¯Ø§Ø¡ Ø§Ù„ØµÙ - {{ selected_class.name }}");
});

function updatePerformanceData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
    }

    // Reload page with new date parameters
    window.location.href = `{{ url_for('class_performance', class_id=selected_class.id) }}?start=${startDate}&end=${endDate}`;
}

function sortStudents(criteria, evt) {
    const tbody = document.getElementById('studentsTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        let aVal, bVal;

        switch(criteria) {
            case 'rank':
                aVal = parseInt(a.dataset.rank);
                bVal = parseInt(b.dataset.rank);
                return aVal - bVal; // Ascending for rank
            case 'attendance':
                aVal = parseFloat(a.dataset.attendance);
                bVal = parseFloat(b.dataset.attendance);
                return bVal - aVal; // Descending for attendance
            case 'streak':
                aVal = parseInt(a.dataset.streak);
                bVal = parseInt(b.dataset.streak);
                return bVal - aVal; // Descending for streak
            case 'name':
                aVal = a.dataset.name;
                bVal = b.dataset.name;
                return aVal.localeCompare(bVal, 'ar'); // Alphabetical
            default:
                return 0;
        }
    });

    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));

    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    // support both passed event and global window.event
    const srcEvent = evt || window.event;
    if (srcEvent && srcEvent.target) srcEvent.target.classList.add('active');
 }

 function viewStudentDetails(studentId) {
    // Navigate to student details page
    window.location.href = `{{ url_for('student', student_id=0) }}`.replace('0', studentId);
}
</script>
{% endblock %}
